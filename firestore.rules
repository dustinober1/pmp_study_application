rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================

    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if user owns the resource
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if user is admin (using custom claims)
    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    // Validate that required fields exist in incoming data
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Validate domain ID
    function isValidDomain(domainId) {
      return domainId in ['people', 'process', 'business_environment'];
    }

    // Validate rating (FSRS 1-4 scale)
    function isValidRating(rating) {
      return rating is int && rating >= 1 && rating <= 4;
    }

    // Validate card state (FSRS states 0-3)
    function isValidCardState(state) {
      return state is int && state >= 0 && state <= 3;
    }

    // ========================================================================
    // STATIC REFERENCE DATA (Admin-only write)
    // ========================================================================

    // Domains collection - PMP exam domains
    match /domains/{domainId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Tasks collection - PMP exam tasks
    match /tasks/{taskId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Master flashcard content - Admin-managed
    match /flashcardContent/{contentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ========================================================================
    // USER COLLECTION
    // ========================================================================

    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);

      // Users can create their profile on signup
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && hasRequiredFields(['uid', 'email', 'subscriptionTier', 'preferences', 'stats', 'fsrsParameters', 'createdAt', 'updatedAt'])
        && request.resource.data.uid == userId
        && request.resource.data.subscriptionTier in ['free', 'premium'];

      // Users can update their own profile
      allow update: if isOwner(userId)
        && request.resource.data.uid == userId  // Can't change UID
        && request.resource.data.subscriptionTier in ['free', 'premium'];

      // Users can delete their own profile
      allow delete: if isOwner(userId);

      // ======================================================================
      // USER PROGRESS SUBCOLLECTION
      // ======================================================================

      match /progress/{progressId} {
        // Users can read their own progress
        allow read: if isOwner(userId);

        // System can create/update progress (typically via Cloud Functions)
        allow create: if isOwner(userId)
          && hasRequiredFields(['id', 'userId', 'type', 'domainId', 'totalCards', 'newCards', 'learningCards', 'reviewCards', 'relearningCards', 'masteredCards', 'masteryPercentage', 'totalReviews', 'averageRetention', 'updatedAt'])
          && request.resource.data.userId == userId
          && request.resource.data.type in ['domain', 'task']
          && isValidDomain(request.resource.data.domainId);

        allow update: if isOwner(userId)
          && request.resource.data.userId == userId
          && request.resource.data.type in ['domain', 'task']
          && isValidDomain(request.resource.data.domainId);

        allow delete: if isOwner(userId);
      }

      // ======================================================================
      // USER SETTINGS SUBCOLLECTION (future use)
      // ======================================================================

      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ========================================================================
    // FLASHCARDS COLLECTION
    // ========================================================================

    match /flashcards/{flashcardId} {
      // Users can read their own flashcards
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Users can create flashcards (or Cloud Functions can)
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && hasRequiredFields(['id', 'userId', 'contentId', 'domainId', 'taskId', 'fsrs', 'isSuspended', 'tags', 'createdAt', 'updatedAt'])
        && isValidDomain(request.resource.data.domainId)
        && request.resource.data.fsrs.keys().hasAll(['state', 'difficulty', 'stability', 'due', 'elapsedDays', 'scheduledDays', 'reps', 'lapses'])
        && isValidCardState(request.resource.data.fsrs.state)
        && request.resource.data.fsrs.difficulty >= 0
        && request.resource.data.fsrs.difficulty <= 10
        && request.resource.data.fsrs.stability >= 0
        && request.resource.data.fsrs.reps >= 0
        && request.resource.data.fsrs.lapses >= 0;

      // Users can update their flashcards
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid
        && isValidDomain(request.resource.data.domainId)
        && isValidCardState(request.resource.data.fsrs.state)
        && request.resource.data.fsrs.difficulty >= 0
        && request.resource.data.fsrs.difficulty <= 10
        && request.resource.data.fsrs.stability >= 0
        && request.resource.data.fsrs.reps >= 0
        && request.resource.data.fsrs.lapses >= 0;

      // Users can delete their flashcards
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // STUDY SESSIONS COLLECTION
    // ========================================================================

    match /studySessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Users can create study sessions
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && hasRequiredFields(['id', 'userId', 'startedAt', 'durationSeconds', 'scope', 'cardsReviewed', 'cardsNew', 'cardsRelearning', 'ratings', 'reviews', 'platform', 'createdAt'])
        && request.resource.data.scope.type in ['all', 'domain', 'task']
        && request.resource.data.platform in ['web', 'ios', 'android']
        && request.resource.data.ratings.keys().hasAll(['again', 'hard', 'good', 'easy'])
        && request.resource.data.cardsReviewed >= 0
        && request.resource.data.durationSeconds >= 0;

      // Users can update their sessions (to mark as ended)
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;

      // Users can delete their sessions
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // REVIEW HISTORY COLLECTION
    // ========================================================================

    match /reviewHistory/{reviewId} {
      // Users can read their own review history
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Users/system can create review records
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && hasRequiredFields(['id', 'userId', 'flashcardId', 'contentId', 'sessionId', 'domainId', 'taskId', 'rating', 'timeSpent', 'stateBefore', 'stateAfter', 'dueBefore', 'dueAfter', 'difficultyBefore', 'difficultyAfter', 'stabilityBefore', 'stabilityAfter', 'reviewedAt', 'createdAt'])
        && isValidDomain(request.resource.data.domainId)
        && isValidRating(request.resource.data.rating)
        && isValidCardState(request.resource.data.stateBefore)
        && isValidCardState(request.resource.data.stateAfter)
        && request.resource.data.timeSpent >= 0;

      // Reviews are immutable once created
      allow update: if false;

      // Users can delete their review history
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // DEFAULT DENY
    // ========================================================================

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
