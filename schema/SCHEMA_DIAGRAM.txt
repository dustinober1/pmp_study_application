PMP Study App - Firestore Schema Diagram
=========================================

STATIC REFERENCE DATA (Admin-managed, Read-only for users)
===========================================================

┌─────────────────────────────────────────┐
│  domains/                               │
│  ├── people                             │
│  ├── process                            │
│  └── business_environment               │
│                                         │
│  Fields:                                │
│  • id: string                           │
│  • name: string                         │
│  • percentage: number (33, 41, 26)      │
│  • description: string                  │
│  • taskIds: string[]                    │
│  • createdAt: Date                      │
│  • updatedAt: Date                      │
└─────────────────────────────────────────┘
                  │
                  │ Contains
                  ▼
┌─────────────────────────────────────────┐
│  tasks/                                 │
│  ├── people-1                           │
│  ├── people-2                           │
│  ├── ...                                │
│  ├── process-1                          │
│  ├── ...                                │
│  └── business_environment-N             │
│                                         │
│  Fields:                                │
│  • id: string (e.g., 'people-1')        │
│  • domainId: string                     │
│  • taskNumber: number                   │
│  • title: string                        │
│  • description: string                  │
│  • flashcardIds: string[]               │
│  • createdAt: Date                      │
│  • updatedAt: Date                      │
└─────────────────────────────────────────┘
                  │
                  │ Contains
                  ▼
┌─────────────────────────────────────────┐
│  flashcardContent/                      │
│  ├── fc-001                             │
│  ├── fc-002                             │
│  └── ... (~500 flashcards)              │
│                                         │
│  Fields:                                │
│  • id: string                           │
│  • domainId: string                     │
│  • taskId: string                       │
│  • front: string (question)             │
│  • back: string (answer)                │
│  • hints: string[]                      │
│  • references: string[]                 │
│  • difficulty: 'easy'|'medium'|'hard'   │
│  • tags: string[]                       │
│  • version: number                      │
│  • stats: {                             │
│      totalReviews: number,              │
│      averageRating: number,             │
│      averageRetention: number           │
│    }                                    │
│  • isActive: boolean                    │
│  • createdAt: Date                      │
│  • updatedAt: Date                      │
└─────────────────────────────────────────┘


USER DATA (User-owned, private per user)
=========================================

┌─────────────────────────────────────────┐
│  users/{userId}                         │
│                                         │
│  Fields:                                │
│  • uid: string (Firebase Auth)          │
│  • email: string                        │
│  • displayName: string                  │
│  • photoURL: string                     │
│  • subscriptionTier: 'free'|'premium'   │
│  • subscriptionExpiresAt: Date          │
│  • preferences: {                       │
│      dailyGoal: number,                 │
│      studyReminderTime: string,         │
│      enableNotifications: boolean,      │
│      theme: 'light'|'dark'|'auto'       │
│    }                                    │
│  • stats: {                             │
│      totalCardsStudied: number,         │
│      currentStreak: number,             │
│      longestStreak: number,             │
│      totalStudyTime: number,            │
│      lastStudyDate: Date                │
│    }                                    │
│  • fsrsParameters: {                    │
│      requestRetention: number,          │
│      maximumInterval: number,           │
│      w: number[17]                      │
│    }                                    │
│  • createdAt: Date                      │
│  • updatedAt: Date                      │
└─────────────────────────────────────────┘
                  │
                  │ Has subcollection
                  ▼
┌─────────────────────────────────────────┐
│  users/{userId}/progress/               │
│  ├── people (domain-level)              │
│  ├── process (domain-level)             │
│  ├── business_environment (domain)      │
│  ├── people-1 (task-level)              │
│  ├── people-2 (task-level)              │
│  └── ... (26 task-level docs)           │
│                                         │
│  Fields:                                │
│  • id: string                           │
│  • userId: string                       │
│  • type: 'domain' | 'task'              │
│  • domainId: string                     │
│  • taskId: string (optional)            │
│  • totalCards: number                   │
│  • newCards: number (state=0)           │
│  • learningCards: number (state=1)      │
│  • reviewCards: number (state=2)        │
│  • relearningCards: number (state=3)    │
│  • masteredCards: number                │
│  • masteryPercentage: number            │
│  • totalReviews: number                 │
│  • averageRetention: number (0-1)       │
│  • lastStudiedAt: Date                  │
│  • updatedAt: Date                      │
└─────────────────────────────────────────┘


FLASHCARD INSTANCES (User-owned, references content)
====================================================

┌─────────────────────────────────────────┐
│  flashcards/                            │
│  ├── {userId}-{contentId}-001           │
│  ├── {userId}-{contentId}-002           │
│  └── ... (~500 per user)                │
│                                         │
│  Fields:                                │
│  • id: string                           │
│  • userId: string ──────────────┐       │
│  • contentId: string (ref) ─────┼───┐   │
│  • domainId: string             │   │   │
│  • taskId: string               │   │   │
│  • fsrs: {                      │   │   │
│      state: 0|1|2|3,            │   │   │
│        (0=NEW, 1=LEARNING,      │   │   │
│         2=REVIEW, 3=RELEARN)    │   │   │
│      difficulty: number (0-10), │   │   │
│      stability: number (days),  │   │   │
│      lastReview: Date,          │   │   │
│      due: Date,                 │   │   │
│      elapsedDays: number,       │   │   │
│      scheduledDays: number,     │   │   │
│      reps: number,              │   │   │
│      lapses: number             │   │   │
│    }                            │   │   │
│  • isSuspended: boolean         │   │   │
│  • tags: string[]               │   │   │
│  • notes: string                │   │   │
│  • createdAt: Date              │   │   │
│  • updatedAt: Date              │   │   │
└─────────────────────────────────┼───┼───┘
                                  │   │
                   References     │   │
                   flashcardContent  │
                                  │   │
                          Owned by user


STUDY SESSIONS (User-owned, session records)
=============================================

┌─────────────────────────────────────────┐
│  studySessions/                         │
│  ├── session-001                        │
│  ├── session-002                        │
│  └── ... (~2 per day per user)          │
│                                         │
│  Fields:                                │
│  • id: string                           │
│  • userId: string                       │
│  • startedAt: Date                      │
│  • endedAt: Date                        │
│  • durationSeconds: number              │
│  • scope: {                             │
│      type: 'all'|'domain'|'task',       │
│      domainId: string,                  │
│      taskId: string                     │
│    }                                    │
│  • cardsReviewed: number                │
│  • cardsNew: number                     │
│  • cardsRelearning: number              │
│  • ratings: {                           │
│      again: number (rating=1),          │
│      hard: number (rating=2),           │
│      good: number (rating=3),           │
│      easy: number (rating=4)            │
│    }                                    │
│  • reviews: ReviewItem[] {              │
│      flashcardId: string,               │
│      contentId: string,                 │
│      domainId: string,                  │
│      taskId: string,                    │
│      rating: 1|2|3|4,                   │
│      timeSpent: number,                 │
│      previousState: 0|1|2|3,            │
│      newState: 0|1|2|3,                 │
│      previousDue: Date,                 │
│      newDue: Date                       │
│    }                                    │
│  • platform: 'web'|'ios'|'android'      │
│  • createdAt: Date                      │
└─────────────────────────────────────────┘
                  │
                  │ Contains
                  ▼
┌─────────────────────────────────────────┐
│  reviewHistory/                         │
│  ├── review-001                         │
│  ├── review-002                         │
│  └── ... (~10 per session)              │
│                                         │
│  Fields: (IMMUTABLE after creation)     │
│  • id: string                           │
│  • userId: string                       │
│  • flashcardId: string (ref)            │
│  • contentId: string (ref)              │
│  • sessionId: string (parent)           │
│  • domainId: string                     │
│  • taskId: string                       │
│  • rating: 1|2|3|4                      │
│  • timeSpent: number (seconds)          │
│  • stateBefore: 0|1|2|3                 │
│  • stateAfter: 0|1|2|3                  │
│  • dueBefore: Date                      │
│  • dueAfter: Date                       │
│  • difficultyBefore: number             │
│  • difficultyAfter: number              │
│  • stabilityBefore: number              │
│  • stabilityAfter: number               │
│  • reviewedAt: Date                     │
│  • createdAt: Date                      │
└─────────────────────────────────────────┘


RELATIONSHIPS
=============

Domain (1) ─── Contains ──→ Task (N)
Task (1) ───── Contains ──→ FlashcardContent (N)
FlashcardContent (1) ─ Referenced by ──→ Flashcard (N) [per user]
User (1) ────── Owns ──→ Flashcard (N)
User (1) ────── Owns ──→ Progress (29: 3 domains + 26 tasks)
User (1) ────── Owns ──→ StudySession (N)
StudySession (1) Contains ──→ ReviewHistory (N)
Flashcard (1) ── Has ──→ ReviewHistory (N)


DATA FLOW: STUDYING A CARD
===========================

1. Query Due Cards
   ┌──────────────────────┐
   │ GET /flashcards      │
   │ WHERE userId = X     │
   │ WHERE fsrs.due <= now│
   │ ORDER BY fsrs.due    │
   └──────────────────────┘
              ▼
2. Fetch Content
   ┌──────────────────────────┐
   │ GET /flashcardContent    │
   │ WHERE id = contentId     │
   └──────────────────────────┘
              ▼
3. User Reviews (rates 1-4)
              ▼
4. Run FSRS Algorithm
   ┌──────────────────────────┐
   │ Calculate new:           │
   │ • state                  │
   │ • difficulty             │
   │ • stability              │
   │ • due date               │
   └──────────────────────────┘
              ▼
5. Update Flashcard
   ┌──────────────────────────┐
   │ UPDATE /flashcards/{id}  │
   │ SET fsrs = newFSRS       │
   └──────────────────────────┘
              ▼
6. Create Review Record
   ┌──────────────────────────┐
   │ CREATE /reviewHistory    │
   │ WITH state transitions   │
   └──────────────────────────┘
              ▼
7. Update Session
   ┌──────────────────────────┐
   │ UPDATE /studySessions    │
   │ ADD to reviews[]         │
   │ INCREMENT counters       │
   └──────────────────────────┘
              ▼
8. Update Progress (via Cloud Function)
   ┌──────────────────────────┐
   │ UPDATE progress/         │
   │ Recalculate metrics      │
   └──────────────────────────┘


FSRS STATE MACHINE
==================

    ┌─────────────────────────────────────────┐
    │              NEW (0)                    │
    │        Never studied before             │
    └─────────────────────────────────────────┘
                    │
              First review
                    ▼
    ┌─────────────────────────────────────────┐
    │           LEARNING (1)                  │
    │      Currently being learned            │
    │   (stability < threshold)               │
    └─────────────────────────────────────────┘
                    │
         Stability increases
                    ▼
    ┌─────────────────────────────────────────┐
    │            REVIEW (2)                   │
    │      Established in memory              │
    │   (stability >= threshold)              │
    └─────────────────────────────────────────┘
                    │
         ┌──────────┴──────────┐
         │                     │
    Rating 3-4            Rating 1-2
    (correct)             (forgot)
         │                     │
         │                     ▼
         │      ┌─────────────────────────────┐
         │      │      RELEARNING (3)         │
         │      │    Forgotten, relearn       │
         │      └─────────────────────────────┘
         │                     │
         │              Stability increases
         │                     │
         └─────────────────────┘
                    ▼
              Back to REVIEW


INDEXES VISUALIZATION
=====================

flashcards/
├─ userId + domainId + taskId           (Hierarchy browsing)
├─ userId + fsrs.due                    (Get due cards - CRITICAL)
├─ userId + fsrs.state + fsrs.due       (Filter by state)
├─ userId + domainId + fsrs.due         (Domain-specific due)
├─ userId + domainId + taskId + fsrs.due (Task-specific due)
├─ userId + isSuspended + fsrs.due      (Exclude suspended)
└─ userId + tags + fsrs.due             (Tag filtering)

studySessions/
├─ userId + startedAt                   (Recent sessions - CRITICAL)
├─ userId + scope.domainId + startedAt  (Domain sessions)
├─ userId + scope.taskId + startedAt    (Task sessions)
└─ userId + platform + startedAt        (Platform analytics)

reviewHistory/
├─ userId + flashcardId + reviewedAt    (Card history - CRITICAL)
├─ userId + sessionId + reviewedAt      (Session reviews)
├─ userId + domainId + reviewedAt       (Domain analytics)
├─ userId + taskId + reviewedAt         (Task analytics)
└─ userId + rating + reviewedAt         (Performance analysis)

progress/ (subcollection)
├─ userId + type + masteryPercentage    (Progress dashboard - CRITICAL)
├─ userId + domainId + masteryPercentage (Domain progress)
└─ userId + type + updatedAt            (Recent updates)

flashcardContent/
├─ domainId + taskId + isActive         (Fetch active content)
├─ isActive + difficulty                (Filter by difficulty)
├─ domainId + isActive                  (Domain content)
└─ tags + isActive                      (Tag-based content)
